# 開發進度與計劃

> 基於 `项目架构设计.md` 的實現狀態追蹤  
> 最後更新：2026-01-28

---

## 一、已完成模組

### 1.1 Seed Generation（種子生成）✅

| 功能 | 狀態 | 檔案 |
|------|------|------|
| Diff 解析 → 行號映射 | ✅ 完成 | `extract_seeds.py` |
| AST 定位修改的函數/方法/類 | ✅ 完成 | `extract_seeds.py` |
| 區分 `code_change` vs `test_change` | ✅ 完成 | `extract_seeds.py` |

### 1.2 Call Graph（調用圖構建）✅

| 功能 | 狀態 | 檔案 |
|------|------|------|
| `CALLS` 邊（函數呼叫關係） | ✅ 完成 | `call_graph.py` |
| `DEFINES` 邊（隱含於 all_functions） | ✅ 完成 | `call_graph.py` |
| AST + Tree-sitter 雙解析器 | ✅ 完成 | `call_graph.py` |
| Import alias 解析 | ✅ 完成 | `call_graph.py` |

### 1.3 Impact Propagation（影響傳播）- 基礎版 ✅

| 功能 | 狀態 | 檔案 |
|------|------|------|
| k-hop BFS 傳播 | ✅ 完成 | `process_impacted_set.py` |
| 標記 `is_internal` / `is_test` / `is_external` | ✅ 完成 | `process_impacted_set.py` |

### 1.4 Agent 流程 ✅

| 功能 | 狀態 | 檔案 |
|------|------|------|
| 模板版 Agent（TODO docstring） | ✅ 完成 | `agent.py` |
| LLM 版 Agent | ✅ 完成 | `agent_llm.py` |
| 批量執行 | ✅ 完成 | `agent_batch.py` |
| 負面控制實驗 | ✅ 完成 | `agent_neg_control.py` |

### 1.5 輔助模組 ✅

| 功能 | 狀態 | 檔案 |
|------|------|------|
| Docstring 風格檢測（Google/NumPy/Sphinx） | ✅ 完成 | `docstring_style.py` |
| LLM API 封裝 | ✅ 完成 | `llm_client.py` |
| AST 級 Verifier | ✅ 完成 | agent 內建 |

### 1.6 最新修改（2026-01-28）✅

| 功能 | 狀態 | 說明 |
|------|------|------|
| 移除「無現有 docstring」硬過濾 | ✅ 完成 | 支持更新已有 docstring |
| `_insert_docstring_into_source` 支持更新 | ✅ 完成 | 返回 `"inserted"` 或 `"updated"` |
| 新增 `has_docstring` / `target_action` 字段 | ✅ 完成 | 區分「補缺」vs「糾偏」 |
| **Typed BFS + 權重衰減** | ✅ 完成 | `impact_graph.py` 核心演算法 |
| **節點分數機制** | ✅ 完成 | `I = {(node, score)}` |
| **可解釋路徑** | ✅ 完成 | `best_path` + `edge_types_on_path` |
| **消融實驗配置** | ✅ 完成 | uniform / no_decay / high_decay / calls_only |
| **LLM 模組獨立目錄** | ✅ 完成 | `analyzer/llm/` |

---

## 二、未完成模組

### 2.1 節點類型擴展 ❌

| 節點類型 | 狀態 | 優先級 |
|---------|------|--------|
| `CLI_Command` / `Arg` | ❌ 未實現 | 高 |
| `ConfigKey` / `EnvVar` | ❌ 未實現 | 高 |
| `README_Section` | ❌ 未實現 | 中 |
| `API_Endpoint` | ❌ 未實現 | 低 |
| `Package` / `Version` | ❌ 未實現 | 低 |

### 2.2 邊類型擴展 ❌

| 邊類型 | 狀態 | 優先級 |
|--------|------|--------|
| `CALLS` | ✅ 已有 | - |
| `DEFINES` | ✅ 隱含 | - |
| `DATA_DEP` / `CTRL_DEP` | ❌ 未實現 | 高（論文核心） |
| `EXPOSES_CLI` | ❌ 未實現 | 高 |
| `READS_CONFIG` / `USES_ENV` | ❌ 未實現 | 高 |
| `OVERRIDES` / `IMPLEMENTS` | ❌ 未實現 | 中 |
| `DOCS` | ❌ 未實現 | 中 |

### 2.3 核心演算法 ✅

| 功能 | 狀態 | 優先級 |
|------|------|--------|
| **Typed BFS + 權重衰減** | ✅ 已完成 | **最高（論文創新點）** |
| 節點分數機制 `I = {(node, score)}` | ✅ 已完成 | **最高** |
| H-PPR 演算法（可選） | ❌ 未實現 | 低 |

### 2.4 ToA 動作空間整合 ❌

| 功能 | 狀態 | 優先級 |
|------|------|--------|
| Impact-Gain 打分函數 | ❌ 未實現 | 中 |
| 覆蓋收益 / 成本懲罰計算 | ❌ 未實現 | 中 |
| 基於分數的優先級排序 | ❌ 未實現 | 中 |

### 2.5 擴展功能 ❌

| 功能 | 狀態 | 優先級 |
|------|------|--------|
| README 更新（PatchREADME） | ❌ 未實現 | 中 |
| CLI/Config 局部驗證 | ❌ 未實現 | 中 |

---

## 三、當前進度評估

```
整體完成度：約 65%

├── Seed Generation      ████████████████████ 100%
├── Call Graph (基礎)    ████████████████████ 100%
├── Impact Propagation   ████████████████████ 100%  ✅ Typed BFS + 權重衰減
├── Agent 流程           ████████████████████ 100%
├── 節點/邊類型擴展      ████░░░░░░░░░░░░░░░░  20%  ← 只有 CALLS/DEFINES
├── ToA 整合             ░░░░░░░░░░░░░░░░░░░░   0%
└── README 更新          ░░░░░░░░░░░░░░░░░░░░   0%
```

---

## 四、下一步計劃

### Phase 1：論文核心創新點 ✅ 已完成

#### 1.1 Typed BFS + 權重衰減 ✅

**已實現：** `impact_graph.py`

```python
# 核心公式
score(v) = max_{p: seed→v} ∏_{e∈p} w(type(e)) · γ^|p|

# API
propagate_impacts_typed(seeds, call_graph, config)
# 返回: {qualname: ImpactedNode(score, hop, best_path, edge_types_on_path, ...)}
```

**已支持消融實驗：**
- `uniform`: 等權重 baseline
- `no_decay`: 無 hop 衰減
- `high_decay`: 高衰減
- `calls_only`: 只考慮 CALLS 邊

---

### Phase 2：補充邊類型（下一步）

#### 2.1 新增 CLI/Config 抽取器

**目標：** 從代碼中抽取 CLI 參數和配置鍵

**新增檔案：** `cli_config_extractor.py`

**抽取模式：**
- `argparse.add_argument("--xxx")`
- `@click.option("--xxx")`
- `typer.Option(...)`
- `os.getenv("KEY")`
- `config["key"]`

**輸出：**
- `CLI_Arg` / `ConfigKey` 節點
- `EXPOSES_CLI` / `READS_CONFIG` 邊

**預估工時：** 1 天

#### 2.2 整合到 impact_graph

- 將 CLI/Config 節點加入調用圖
- 連接 EXPOSES_CLI / READS_CONFIG 邊

**預估工時：** 0.5 天

---

### Phase 3：實驗與論文數據

#### 3.1 對比實驗

| 配置 | 說明 | 狀態 |
|------|------|------|
| Baseline | 等權重 BFS | ✅ `--ablation uniform` |
| Typed BFS | 帶權重衰減 | ✅ `--ablation full` |
| + CLI/Config | 加入介面節點 | ❌ 待實現 |

#### 3.2 評估指標

- Precision / Recall of impacted set
- Patch 正確性（verifier 通過率）
- 執行效率（節點數、邊數、時間）

**預估工時：** 1-2 天

---

## 五、任務優先級排序

| 優先級 | 任務 | 預估工時 | 狀態 |
|--------|------|----------|------|
| ~~P0~~ | ~~Typed BFS + 權重衰減~~ | ~~1-2天~~ | ✅ 已完成 |
| ~~P0~~ | ~~節點分數機制~~ | ~~0.5天~~ | ✅ 已完成 |
| **P1** | CLI/Config 抽取器 | 1天 | ❌ 待實現 |
| **P1** | EXPOSES_CLI / READS_CONFIG 邊 | 0.5天 | ❌ 待實現 |
| P2 | 對比實驗（消融） | 1天 | 🔄 可開始 |
| P3 | README 更新功能 | 2天 | ❌ 待實現 |
| P3 | H-PPR 演算法（可選） | 2天 | ❌ 低優先 |

---

## 六、文件清單

```
analyzer/
├── llm/                           # ✅ LLM 獨立模組
│   ├── __init__.py
│   └── llm_client.py              # LLM API 封裝
│
└── unidiff_extract/
    ├── extract_seeds.py           # ✅ 種子生成
    ├── call_graph.py              # ✅ 調用圖構建
    ├── impact_graph.py            # ✅ Typed BFS + 權重衰減（核心）
    ├── process_impacted_set.py    # ✅ 影響傳播（等權重版）
    ├── process_impacted_set_typed.py # ✅ 影響傳播（Typed BFS 版）
    ├── agent.py                   # ✅ 模板版 Agent
    ├── agent_llm.py               # ✅ LLM 版 Agent
    ├── agent_batch.py             # ✅ 批量執行
    ├── agent_neg_control.py       # ✅ 負面控制
    ├── docstring_style.py         # ✅ 風格檢測
    ├── llm_client.py              # ⚠️ 舊版（保留兼容）
    ├── cli_config_extractor.py    # ❌ 待新增
    └── README.md                  # ✅ 使用說明
```

---

*文檔版本：v1.0*  
*建立日期：2026-01-28*

# Black Commit fe875c0 README

## Executive Summary
This commit (fe875c0) introduces critical changes to Black's handling of file encoding and line endings. The primary improvements include:
- Enforcing UTF-8 decoding for all source files regardless of encoding declarations
- Adding support for CR-only line endings preservation
- Enhancing encoding override capabilities in file processing

These changes aim to improve consistency in formatting behavior across different file encodings and line ending styles while maintaining backward compatibility for standard use cases.

## Changed Modules
- `src.black.__init__` (main module)

## Affected Functions

### Directly Modified Functions

#### `_format_str_once(src_contents, mode, lines)`
- **Change**: Added explicit UTF-8 encoding override in internal decoding
- **Why**: To prevent inconsistent formatting from source file encoding declarations
- **Impact**: 
  - Stability checks may now fail for non-UTF-8 files
  - Formatting behavior becomes predictable regardless of source encoding comments
  - Maintains same public interface and core formatting functionality

#### `decode_bytes(src, mode, encoding_overwrite=None)`
- **Change**: Added encoding override parameter and CR line ending support
- **Why**: To enable forced encoding conversion and handle edge-case line terminators
- **Impact**:
  - Callers can bypass automatic encoding detection
  - Newline return values may contain CR characters
  - Maintains backward compatibility for typical UTF-8/LF workflows

---

### Indirectly Affected Functions

#### `assert_stable(src_contents, mode)`
- **Change**: Affected by UTF-8 enforcement in formatting
- **Why**: Stability checks now use standardized encoding
- **Impact**:
  - May report new failures for non-UTF-8 encoded files
  - Reveals previously hidden formatting inconsistencies

#### `format_file_in_place(path, mode)`
- **Change**: Preserves CR-only line endings
- **Why**: Due to decode_bytes newline handling changes
- **Impact**:
  - Output files may retain CR-only terminators
  - Changes diff outputs for files with mixed line endings

#### `format_stdin_to_stdout(mode)`
- **Change**: Inherits CR handling and encoding changes
- **Impact**: May produce output with CR-only line endings

#### `check_stability_and_equivalence(src, mode)`
- **Change**: Affected by UTF-8 decoding enforcement
- **Impact**:
  - Stability checks ignore source encoding declarations
  - Potential false positives in verification workflows

#### `reformat_one(path, mode)`
- **Change**: Inherits CR preservation behavior
- **Impact**:
  - Output retains input's CR-only line endings
  - Affects diff outputs and line ending-sensitive environments

#### `reformat_code(code, mode)`
- **Change**: Indirectly affected by decoding changes
- **Impact**: Maintains core functionality but inherits new encoding handling

---

## Overall Impact Analysis
The changes in fe875c0 work together to create a more consistent formatting environment by:
1. **Standardizing on UTF-8**: Eliminates variability from source file encoding declarations
2. **Enhancing Line Ending Support**: Properly handles CR-only files without conversion
3. **Improving Error Detection**: Reveals hidden formatting inconsistencies through stricter checks

While maintaining backward compatibility for standard UTF-8/LF workflows, these changes may affect:
- Projects using non-UTF-8 encoded files (will now format as UTF-8)
- Systems expecting automatic line ending conversion
- CI pipelines relying on stability checks for mixed-encoding files

The commit resolves issues with non-UTF-8 file corruption (#4964) and improves handling of edge-case line endings while preserving core functionality.
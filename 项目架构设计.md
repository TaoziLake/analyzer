# 基於 CPG 異構圖的增量文檔維護系統架構設計

## 1. 系統概述

本系統旨在建立一套從程式碼變更（diff）到文檔自動維護的端到端框架。核心思想是：透過 **Code Property Graph (CPG) 異構圖**進行影響分析，獲取 **Impacted Entity Set**，進而縮小 Tree-of-Actions (ToA) 的動作空間，實現精準、可解釋的文檔增量更新。

---

## 2. 異構圖結構設計

### 2.1 節點類型（Node Types）

從「文檔更新」視角出發，系統定義以下節點類型：

| 類別 | 節點類型 | 說明 |
|------|----------|------|
| **程式碼實體** | `Function` / `Method` / `Class` / `Module` / `File` | 程式碼基本單元 |
| **介面實體** | `CLI_Command` / `Arg` / `ConfigKey` / `EnvVar` / `API_Endpoint` | 對外暴露的介面 |
| **文檔實體** | `README_Section` / `Docstring_Block` / `Example_Snippet` | 文檔組成單元（可選） |
| **依賴實體** | `Package` / `Version` | 外部依賴（可選） |

### 2.2 邊類型（Edge Types）

利用 CPG 的優勢，將靜態關係以可解釋的方式表達：

| 邊類型 | 語義 | 來源 |
|--------|------|------|
| `CALLS` | 函數呼叫關係 | Call Graph 分析 |
| `DEFINES` | 檔案/模組定義某函數/類別 | AST 解析 |
| `OVERRIDES` / `IMPLEMENTS` | 物件導向繼承/實作關係 | 語言相關語義分析 |
| `DATA_DEP` | 資料依賴 | CPG 核心能力 |
| `CTRL_DEP` | 控制依賴 | CPG 核心能力 |
| `READS_CONFIG` | 從程式碼讀取配置鍵值 | 規則 + 模式匹配 |
| `USES_ENV` | 使用環境變數 | 規則 + 模式匹配 |
| `EXPOSES_CLI` | CLI 入口與參數暴露 | argparse/click/typer 抽取 |
| `DOCS` | README 段落/Docstring 描述某實體 | 符號名/路徑/標題映射 |

此結構形成 **程式碼-介面-文檔** 的異構圖。CPG 負責提供高品質的 `CALLS`/`DATA_DEP`/`CTRL_DEP`，系統補充 CLI/Config/Doc 的邊。

---

## 3. 種子集合生成（Seed Generation）

### 3.1 輸入

系統輸入為 **commit diff**。

### 3.2 種子映射規則

將 diff 映射到種子節點：

1. **被修改的函數/方法/類別**：透過 AST/CPG 定位（行號 → 節點）
2. **被改動的配置/CLI 解析程式碼**：命中模式匹配
   - `add_argument`
   - `@click.option`
   - `os.getenv`
   - `config["x"]`
3. **被改動的 public API**：匯出符號/`__init__.py`/入口點變動

### 3.3 輸出

種子集合：**S = {v₁, v₂, ...}**

---

## 4. 影響傳播演算法（Impact Propagation）

### 4.1 設計目標

找出因本次改動而「語義上需要更新文檔」的實體。此非純粹的 Call Graph 可達性分析，而是**帶類型的影響傳播**。

### 4.2 方案 A：Typed BFS + 權重衰減

**演算法描述：**
1. 從 seeds 出發，按邊類型進行 k-hop 擴展
2. 每走一步乘以衰減係數（不同邊類型不同權重）
3. 僅保留分數超過閾值的節點作為 impacted set

**權重設計原則：**

| 邊類型 | 權重等級 | 理由 |
|--------|----------|------|
| `EXPOSES_CLI` / `READS_CONFIG` | 最高 | 直接影響 README usage/config |
| `DATA_DEP` | 高 | 參數/回傳值變化常透過資料依賴影響外部 |
| `CALLS` | 中 | 呼叫關係傳遞影響 |
| 其他 | 低 | 間接影響 |

**截斷策略：** hop 超過 3~4 通常噪聲增大，進行截斷。

**輸出：** I = { (node, score) }

### 4.3 方案 B：Heterogeneous Personalized PageRank (H-PPR)

**演算法描述：**
1. 在異構圖上執行 PPR
2. 轉移矩陣按邊類型加權
3. 以 seeds 為 personalization 向量
4. 獲得每個節點的「受影響機率分數」

**優點：** 更具方法論性、結果更平滑

**缺點：** 實作稍複雜

---

## 5. ToA 動作空間整合

### 5.1 動作候選生成（Action Candidates）

動作僅圍繞 impacted set 產生：

| 動作類型 | 說明 |
|----------|------|
| `ReadContext(entity)` | 讀取該實體定義/周邊依賴（CPG 提供鄰居） |
| `UpdateDocstring(entity)` | 對 impacted 的函數/類別更新 docstring |
| `PatchREADME(section)` | 對 impacted 的 README 段落進行補丁更新 |
| `RunVerifier(kind)` | 對 CLI/config/docstring/範例進行校驗 |

**效益：** 候選動作數量從「數十至上百」降至「個位數至十幾個」。

### 5.2 打分函數設計

**Impact-Gain(action) = 受影響覆蓋收益 − 成本懲罰**

#### 覆蓋收益
該動作能覆蓋多少高分 impacted 節點/關係：

```
Coverage(action) = Σ score(v), for v ∈ impacted nodes that action addresses
```

#### 成本懲罰
動作代價（讀檔案、呼叫工具、執行 verifier）：

```
Cost(action) = 經驗常數 或 歷史統計值
```

#### 文檔缺口加分
若當前 README/Docstring 尚未包含該實體/配置鍵值，則收益更高。

### 5.3 ToA 執行策略

1. **優先執行**覆蓋最大、成本低的動作（如更新 docstring 參數列表）
2. **其次執行** README 特定小節更新
3. **最後執行** verifier（失敗則回溯到相關實體的動作節點）

### 5.4 學術貢獻

- 將 ToA 的「探索」從文字啟發式（TF-IDF 熵）轉變為**靜態語義結構引導**
- 輸出的 impacted set 可作為**可解釋證據**：說明為何修改特定 README 段落

---

## 6. Verifier 與 Impacted Set 聯動

### 6.1 局部驗證策略

有 impacted set 後，Verifier 無需全 README 掃描：

| impacted 包含 | 驗證範圍 |
|---------------|----------|
| `CLI_Arg` | README Usage 段的相關命令/參數 |
| `ConfigKey` | Config 表格/段落是否覆蓋這些 key |
| `Function signature` | 對應函數的 docstring 參數一致性 |

### 6.2 效益

- **更快**：減少不必要的掃描
- **更準**：聚焦真正受影響的區域
- **閉環**：局部驗證 + 反思回滾

---

## 7. 技術選型

### 7.1 CPG 獲取工具

| 工具 | 適用場景 |
|------|----------|
| **Joern** | 程式碼 → CPG（支援 C/C++/Java/JS 等），圖查詢方便 |
| **CodeQL** | 偏語義查詢，適合「影響查詢」 |
| **AST + Call Graph 庫** | Python-only 輕量 CPG 近似版（可稱「CPG-inspired」） |

### 7.2 異構圖儲存

| 方案 | 說明 |
|------|------|
| NetworkX / igraph | 輕量級，足以應付中小型專案 |
| SQLite / CSV | 邊表儲存，傳播演算法自行實作 |

---

## 8. 論文創新點

1. **任務/框架創新**：提出 Diff → CPG 異構圖影響分析 → 文檔補丁生成的新任務框架（增量維護而非全量生成）

2. **方法創新**：設計 Hetero-Impact Propagation 獲取 impacted entity set，用於縮小 ToA 動作空間並提升可解釋性與準確性

3. **系統創新**：將 impacted set 與 Verifier 聯動，實現「局部驗證 + 反思回滾」的閉環，降低幻覺並減少無關改動

---

## 9. 最小可行原型（MVP）

### 9.1 第一階段：Python repo + Docstring

1. **diff → AST**：找到修改函數/簽名變化（seed）
2. **構建簡化圖**：`CALLS`（靜態解析/符號引用）+ `DEFINES`
3. **Typed BFS**：獲取 impacted 函數集合
4. **Docstring patch + Docstring verifier**

### 9.2 第二階段：擴展

- README 更新
- 加入 CLI/Config 節點

---

## 10. 系統架構圖

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Commit Diff 輸入                             │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Seed Generation Module                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │ AST 定位     │  │ 模式匹配     │  │ API 變動檢測 │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                         Seeds S = {v₁, v₂, ...}
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    CPG 異構圖構建 & 儲存                             │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐                │
│  │Code Node│  │Interface│  │Doc Node │  │Dep Node │                │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘                │
│       ↕ CALLS / DATA_DEP / CTRL_DEP / EXPOSES_CLI / DOCS ↕         │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│              Impact Propagation (Typed BFS / H-PPR)                 │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                    Impacted Entity Set I = {(node, score)}
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    ToA Action Space (縮減後)                        │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐        │
│  │ ReadContext    │  │ UpdateDocstring│  │ PatchREADME    │        │
│  └────────────────┘  └────────────────┘  └────────────────┘        │
│                      Impact-Gain 打分 & 排序                        │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         Verifier Module                             │
│              (局部驗證：CLI / Config / Docstring)                   │
│                        ↓ 失敗 → 回溯重試                            │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       文檔補丁輸出 (Patches)                        │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 附錄：術語表

| 術語 | 定義 |
|------|------|
| CPG (Code Property Graph) | 結合 AST、CFG、PDG 的程式碼屬性圖 |
| Impacted Entity Set | 受 diff 影響需更新文檔的實體集合 |
| ToA (Tree-of-Actions) | 動作樹搜索框架 |
| H-PPR | 異構個人化 PageRank |
| Seed | 從 diff 直接映射得到的初始受影響節點 |

---

*文檔版本：v1.0*  
*最後更新：2026-01-28*
